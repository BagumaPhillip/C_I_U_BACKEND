generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model LecturerSignUp {
  id               Int       @id @default(autoincrement())
  first_name       String
  last_name        String
  email            String    @unique
  role             String
  token            String?
  tokenExpiry      DateTime?
  password         String?
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
}

model AdminSignUp {
  id               Int       @id @default(autoincrement())
  first_name       String
  last_name        String
  email            String    @unique
  role             String
  password         String
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
}

model users {
  id               Int           @id @default(autoincrement())
  first_name       String
  last_name        String
  email            String        @unique
  program          String
  createdAt        DateTime      @default(now())
  lastLogin        DateTime?
  registrationNo   String        @unique
  password         String
  role             String
  resetToken       String?       @unique
  resetTokenExpiry DateTime?
  courseId         Int
  issueReports     IssueReport[] @relation("StudentReports")
  submissions      Submission[]
  course           courses       @relation(fields: [courseId], references: [id])
  courses          courses[]     @relation("UserCourses")
  // Relationship with Score (opposite relation field)
  scores           Score[]       @relation("StudentScores")
}

model IssueReport {
  id               Int      @id @default(autoincrement())
  issueDescription String
  regno            String
  reportedAt       DateTime @default(now())
  studentId        Int
  student          users    @relation("StudentReports", fields: [studentId], references: [id])
}

model FAQ {
  id       Int    @id @default(autoincrement())
  question String
  answer   String
}

model Submission {
  id           Int              @id @default(autoincrement())
  studentId    Int
  assessmentId Int
  answers      Json
  score        Int
  percentage   Float
  submittedAt  DateTime
  assessment   ManualAssessment @relation(fields: [assessmentId], references: [id])
  student      users            @relation(fields: [studentId], references: [id])
}

model Score {
  id            Int      @id @default(autoincrement())
  examId        Int
  userId        Int
  score         Int
  percentage    Float
  timeSubmitted DateTime @default(now())
  createdAt     DateTime @default(now())
  student       users    @relation("StudentScores", fields: [userId], references: [id])
  assessment    addAssessment?    @relation("AssessmentScores", fields: [examId], references: [id], map: "Score_examId_fkey") // Unique map name
  manualAssessment ManualAssessment? @relation("ManualAssessmentScores", fields: [examId], references: [id], map: "Score_examId_manual_fkey") // Unique map name
}


model courses {
  id                Int                @id @default(autoincrement())
  facultyName       String
  courseName        String
  courseUnits       String[]
  courseUnitCode    String
  manualAssessments ManualAssessment[]
  addAssessments    addAssessment[]
  users             users[]
  students          users[]            @relation("UserCourses")
}

model addAssessment {
  id             Int        @id @default(autoincrement())
  title          String
  description    String
  courseId       Int
  courseUnit     String
  courseUnitCode String
  duration       String
  scheduledDate  DateTime
  startTime      DateTime
  endTime        DateTime
  createdBy      String
  createdAt      DateTime   @default(now())
  status         String     @default("draft")
  isDraft        Boolean    @default(true)
  questions      Question[] @relation("AssessmentQuestions")
  course         courses    @relation(fields: [courseId], references: [id])
  // Relationship with Score
  scores         Score[]    @relation("AssessmentScores")
}

model Question {
  id           Int           @id @default(autoincrement())
  content      String
  answer       String?
  options      Json
  assessmentId Int
  assessment   addAssessment @relation("AssessmentQuestions", fields: [assessmentId], references: [id])
}

model ManualAssessment {
  id             Int              @id @default(autoincrement())
  title          String
  description    String
  courseId       Int
  courseUnit     String
  courseUnitCode String
  duration       String
  scheduledDate  DateTime
  startTime      DateTime
  endTime        DateTime
  createdBy      String
  createdAt      DateTime         @default(now())
  status         String           @default("draft")
  isDraft        Boolean          @default(true)
  course         courses          @relation(fields: [courseId], references: [id])
  questions      QuestionManual[]
  submissions    Submission[]
  // Relationship with Score
  scores         Score[] @relation("ManualAssessmentScores")
}

model QuestionManual {
  id           Int              @id @default(autoincrement())
  content      String
  answer       String?
  options      Json
  assessmentId Int
  assessment   ManualAssessment @relation(fields: [assessmentId], references: [id])
}

model ExamProgress {
  id              Int      @id @default(autoincrement())
  studentId       Int
  examId          Int
  currentQuestion Int
  answers         Json
  timeSpent       Int
  status          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([studentId, examId])
}
